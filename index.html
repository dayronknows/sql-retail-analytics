<!-- INTERACTIVITY -->
<script>
  const CSV = 'assets/data/';
  const BUST = `?v=${Date.now()}`; // cache-buster so updates show up immediately

  // Tab toggles
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.tab;
      const view = btn.dataset.view; // 'chart' | 'code'
      document.querySelectorAll(`button[data-tab="${key}"]`).forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`${key}-chart`)?.classList.toggle('hidden', view !== 'chart');
      document.getElementById(`${key}-code`)?.classList.toggle('hidden', view !== 'code');
    });
  });

  // CSV loader (more robust + no-store)
  async function loadCSV(path) {
    try {
      const txt = await fetch(path, { cache: 'no-store' }).then(r => r.ok ? r.text() : Promise.reject(r.status));
      return new Promise((res, rej) => Papa.parse(txt, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        transformHeader: h => h.trim(),
        complete: r => res(r.data),
        error: rej
      }));
    } catch (e) {
      console.warn('CSV load failed:', path, e);
      return null;
    }
  }

  // ===== Monthly Trend with Year filters =====
  (async function(){
    const rows = await loadCSV(CSV + 'monthly_trend.csv' + BUST); // order_year,order_month,total_sales
    if(!rows || !rows.length) return;

    const years = [...new Set(rows.map(r => r.order_year))].sort((a,b)=>a-b);
    const container = document.getElementById('trend-years');
    const selected = new Set(years);
    years.forEach(y => {
      const chip = document.createElement('button');
      chip.className = "px-3 py-1 rounded-full border border-[var(--border)] text-sm data-[off]:opacity-50 data-[off]:line-through";
      chip.textContent = y; chip.dataset.year = y;
      chip.onclick = () => { selected.has(y) ? selected.delete(y) : selected.add(y); chip.toggleAttribute('data-off', !selected.has(y)); render(); };
      container.appendChild(chip);
    });

    const ctx = document.getElementById('monthlyChart').getContext('2d');
    let chart;
    function render(){
      const data = rows.filter(r => selected.has(r.order_year))
                       .map(r => ({ label: `${r.order_year}-${String(r.order_month).padStart(2,'0')}`, v:+r.total_sales }));
      const labels = data.map(d => d.label);
      const values = data.map(d => d.v);
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Total Sales', data:values }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });
    }
    render();
  })();

  // ===== Cumulative Sales =====
  (async function(){
    const rows = await loadCSV(CSV + 'cumulative_sales.csv' + BUST); // month_start,monthly_sales,cumulative_sales
    if(!rows || !rows.length) return;
    const labels = rows.map(r => r.month_start);
    const monthly = rows.map(r => +r.monthly_sales);
    const cum = rows.map(r => +r.cumulative_sales);
    new Chart(document.getElementById('cumulativeChart'), {
      type:'line',
      data:{ labels, datasets:[ { label:'Monthly', data:monthly }, { label:'Cumulative', data:cum } ] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  })();

  // ===== Category Share (fallback to your known % if CSV missing) =====
  (async function(){
    let rows = await loadCSV(CSV + 'category_share.csv' + BUST); // category,pct_total
    let labels, data;
    if(rows && rows.length){
      rows.sort((a,b)=>b.pct_total-a.pct_total);
      labels = rows.map(r => r.category);
      data   = rows.map(r => +r.pct_total);
    } else {
      labels = ['Bikes','Accessories','Clothing'];
      data   = [96.46, 2.39, 1.16];
    }
    new Chart(document.getElementById('categoryChart'), {
      type:'doughnut',
      data:{ labels, datasets:[{ data }] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  })();

  // ===== Top Products =====
  (async function(){
    const rows = await loadCSV(CSV + 'top_products.csv' + BUST); // product_name,total_sales
    if(!rows || !rows.length) return;
    rows.sort((a,b)=>b.total_sales-a.total_sales);
    const labels = rows.map(r => r.product_name);
    const data   = rows.map(r => +r.total_sales);
    new Chart(document.getElementById('productsChart'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Sales', data }] },
      options:{ responsive:true, maintainAspectRatio:false, indexAxis:'y' }
    });
  })();

  // ===== Top Customers (LTV) =====
  (async function(){
    const rows = await loadCSV(CSV + 'top_customers.csv' + BUST); // customer_number,ltv
    if(!rows || !rows.length) return;
    rows.sort((a,b)=>b.ltv-a.ltv);
    const top = rows.slice(0,10);
    const labels = top.map(r => r.customer_number);
    const data   = top.map(r => +r.ltv);
    new Chart(document.getElementById('ltvChart'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'LTV', data }] },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  })();
</script>
